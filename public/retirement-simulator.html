<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Retirement Simulator — ArcVest</title>
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    /* ---------- Arcvest Design System ---------- */
    :root {
      /* Arcvest Color Palette */
      --ast-global-color-0: #1B9C85;  /* Primary Teal */
      --ast-global-color-1: #178E79;  /* Secondary Teal */
      --ast-global-color-2: #0F172A;  /* Dark Navy */
      --ast-global-color-3: #454F5E;  /* Text Gray */
      --ast-global-color-4: rgba(207, 237, 211, 0.34);  /* Light Accent */
      --ast-global-color-5: #FFFFFF;  /* White */
      --ast-border-color: #dddddd;
      
      /* Application Variables */
      --bg: #ffffff;
      --panel: #ffffff;
      --text: #454F5E;
      --text-dark: #0F172A;
      --text-body: #808285;
      --muted: #808285;
      --brand: #1B9C85; /* Primary Teal */
      --brand-2: #178E79; /* Secondary Teal */
      --accent: #1B9C85; /* Teal */
      --red: #cf2e2e;
      --green: #00d084;
      --ring: #1B9C85;
      --radius: 0px; /* Sharp corners like arcvest */
      --shadow: 0 2px 8px rgba(0,0,0,.1);
      --shadow-hover: 0 4px 16px rgba(27, 156, 133, 0.2);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: 'Lora', serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: clamp(16px, 2vw, 32px);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding-bottom: 40px;
    }

    .header {
      margin-bottom: 32px;
      text-align: center;
    }

    .header h1 {
      font-size: clamp(24px, 3vw, 36px);
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 8px;
    }

    .header p {
      color: var(--muted);
      font-size: 16px;
    }

    /* Tabs - HonestMath Inspired */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--ast-border-color);
      margin-bottom: 24px;
      overflow-x: auto;
    }

    .tab {
      background: transparent;
      border: none;
      padding: 16px 24px;
      font-family: var(--sans);
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab:hover {
      color: var(--brand);
      background: rgba(27, 156, 133, 0.05);
    }

    .tab.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Form Groups - Minimalist Style */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dark);
      margin-bottom: 8px;
    }

    .form-input, .form-select {
      width: 100%;
      height: 48px;
      padding: 0 16px;
      border: 1px solid var(--ast-border-color);
      border-radius: var(--radius);
      background: #fff;
      font-family: var(--sans);
      font-size: 16px;
      color: var(--text);
      transition: all 0.2s;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(27, 156, 133, 0.1);
    }

    .form-help {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    /* Asset Allocation Table */
    .allocation-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px;
    }

    .allocation-table th,
    .allocation-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--ast-border-color);
    }

    .allocation-table th {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dark);
      background: #fafafa;
    }

    .allocation-table input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--ast-border-color);
      border-radius: var(--radius);
      font-family: var(--sans);
    }

    .allocation-table input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(27, 156, 133, 0.1);
    }

    .allocation-total {
      font-weight: 700;
      color: var(--text-dark);
    }

    .allocation-error {
      color: var(--red);
      background: rgba(207, 46, 46, 0.1);
    }

    .allocation-success {
      color: var(--green);
    }

    /* Fee Selector */
    .fee-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .fee-option {
      position: relative;
      display: flex;
      align-items: center;
      padding: 16px;
      border: 2px solid var(--ast-border-color);
      border-radius: var(--radius);
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }

    .fee-option:hover {
      border-color: var(--brand);
      background: rgba(27, 156, 133, 0.02);
    }

    .fee-option input[type="radio"] {
      margin-right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--brand);
    }

    .fee-option input[type="radio"]:checked + .fee-label {
      color: var(--brand);
    }

    .fee-option:has(input[type="radio"]:checked) {
      border-color: var(--brand);
      background: rgba(27, 156, 133, 0.05);
    }

    .fee-label {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .fee-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .fee-value {
      font-size: 13px;
      color: var(--muted);
    }

    /* Historical Scenario Cards */
    .historical-card:hover {
      border-color: var(--brand);
      background: rgba(27, 156, 133, 0.02);
    }

    .historical-card.selected {
      border-color: var(--brand);
      background: rgba(27, 156, 133, 0.08);
      box-shadow: 0 0 0 3px rgba(27, 156, 133, 0.15);
    }

    /* Buttons */
    .btn {
      padding: 16px 32px;
      border: none;
      border-radius: var(--radius);
      font-family: var(--sans);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--shadow);
    }

    .btn-primary {
      background: var(--brand);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--brand-2);
      box-shadow: var(--shadow-hover);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--ast-border-color);
      color: var(--text);
    }

    .btn-secondary:hover {
      border-color: var(--brand);
      color: var(--brand);
    }

    .action-bar {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin: 32px 0 48px 0;
    }

    /* Results Panel */
    .results {
      background: #fafafa;
      border: 1px solid var(--ast-border-color);
      border-radius: var(--radius);
      padding: 12px;
      margin-top: 32px;
      display: none;
    }

    .results.visible {
      display: block;
      animation: fadeIn 0.3s;
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }

    .email-pdf-button {
      font-size: 14px;
      padding: 12px 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      box-shadow: var(--shadow-hover);
      padding: clamp(24px, 4vw, 36px);
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
    }

    .modal-close:hover {
      color: var(--brand);
    }

    .modal-content h3 {
      font-size: 20px;
      color: var(--text-dark);
      margin-bottom: 12px;
    }

    .modal-description {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 24px;
    }

    .modal-form-grid {
      margin-bottom: 16px;
    }

    .modal-feedback {
      min-height: 24px;
      font-size: 13px;
      margin-top: 16px;
    }

    .modal-feedback.success {
      color: #059669;
    }

    .modal-feedback.error {
      color: #dc2626;
    }

    .results h2 {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 6px;
      text-align: center;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .result-card {
      background: #fff;
      border: 1px solid var(--ast-border-color);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
    }

    .result-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text);
      margin-bottom: 5px;
    }

    .result-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-dark);
    }

    .result-value.success {
      color: var(--green);
    }

    .result-value.warning {
      color: #f59e0b;
    }

    .result-value.danger {
      color: var(--red);
    }

    /* Scenario Banner */
    .scenario-banner {
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .scenario-montecarlo {
      background: linear-gradient(135deg, #E8F5F3 0%, #D1EBE7 100%);
      border-left: 4px solid var(--brand);
    }
    .scenario-historical {
      background: linear-gradient(135deg, #FFF8E6 0%, #FFEFC2 100%);
      border-left: 4px solid #F59E0B;
    }
    .scenario-type {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .scenario-title {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-dark);
    }
    .scenario-description {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
      line-height: 1.5;
    }

    /* Explanation Section */
    .explanation-section {
      background: #fff;
      border: 1px solid var(--ast-border-color);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .explanation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .explanation-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .collapse-toggle {
      background: none;
      border: none;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      padding: 4px 8px;
      transition: transform 0.2s;
    }
    .collapse-toggle.collapsed {
      transform: rotate(-90deg);
    }
    .explanation-content {
      margin-top: 16px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .explanation-content.collapsed {
      max-height: 0 !important;
      margin-top: 0;
    }
    .explanation-para {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text);
      margin-bottom: 14px;
    }
    .explanation-para:last-child {
      margin-bottom: 0;
    }
    .explanation-para strong {
      color: var(--text-dark);
    }

    /* Compact Metrics */
    .results-grid-compact {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    .result-card-compact {
      background: #fff;
      border: 1px solid var(--ast-border-color);
      border-radius: var(--radius);
      padding: 14px 16px;
      text-align: center;
    }
    .result-label-compact {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .result-value-primary {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-dark);
    }
    .result-value-primary.success { color: var(--green); }
    .result-value-primary.warning { color: #f59e0b; }
    .result-value-primary.danger { color: var(--red); }

    /* Scenario Summary Section */
    .scenario-summary {
      background: #fff;
      border: 1px solid var(--ast-border-color);
      border-radius: var(--radius);
      padding: 20px 24px;
      margin-bottom: 20px;
    }
    .scenario-summary h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 16px;
    }
    .scenario-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    .scenario-item {
      padding: 12px 16px;
      background: var(--gray-50);
      border-radius: 6px;
    }
    .scenario-item-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .scenario-item-value {
      font-size: 14px;
      color: var(--text-dark);
      line-height: 1.5;
    }
    .scenario-item-value strong {
      font-weight: 600;
    }

    /* Secondary Metrics Inline */
    .metrics-secondary {
      background: #fff;
      border: 1px solid var(--ast-border-color);
      border-radius: var(--radius);
      padding: 14px 20px;
      margin-bottom: 20px;
      font-size: 15px;
      color: var(--text);
      line-height: 1.8;
    }
    .metrics-secondary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 24px;
    }
    .metric-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .metric-label {
      color: var(--muted);
    }
    .metric-value {
      font-weight: 600;
      color: var(--text-dark);
    }
    .metric-separator {
      color: var(--ast-border-color);
    }

    .chart-container {
      background: #fff;
      border: 1px solid var(--ast-border-color);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
    }

    .chart-container h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 16px;
    }

    /* Loading Spinner */
    .spinner {
      border: 4px solid rgba(0,0,0,.1);
      border-top-color: var(--brand);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading {
      text-align: center;
      padding: 40px;
    }

    .loading p {
      color: var(--muted);
      margin-top: 16px;
    }

    /* Error Alert */
    .alert {
      padding: 16px;
      border-radius: var(--radius);
      margin-bottom: 24px;
      border: 1px solid;
    }

    .alert-error {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      color: #991b1b;
    }

    .alert-info {
      background: rgba(59, 130, 246, 0.1);
      border-color: #3b82f6;
      color: #1e40af;
    }

    /* Detailed Outcome Table */
    .detailed-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 24px;
      font-size: 13px;
    }

    .detailed-table th,
    .detailed-table td {
      padding: 10px 8px;
      text-align: right;
      border-bottom: 1px solid var(--ast-border-color);
    }

    .detailed-table th {
      background: #fafafa;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.05em;
      color: var(--text-dark);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .detailed-table th:first-child,
    .detailed-table td:first-child {
      text-align: left;
    }

    .detailed-table tr:hover {
      background: #f9f9f9;
    }

    .detailed-table .phase-accumulation {
      background: rgba(27, 156, 133, 0.05);
    }

    .detailed-table .phase-retirement {
      background: rgba(245, 158, 11, 0.05);
    }

    .detailed-table .positive {
      color: #059669;
    }

    .detailed-table .negative {
      color: #dc2626;
    }

    .detailed-table .year-row {
      cursor: pointer;
      transition: background 0.2s;
    }

    .detailed-table .year-row:hover {
      background: rgba(27, 156, 133, 0.1) !important;
    }

    .detailed-table .expand-icon {
      display: inline-block;
      margin-right: 8px;
      transition: transform 0.2s;
      color: var(--brand);
      font-weight: bold;
    }

    .detailed-table .expand-icon.expanded {
      transform: rotate(90deg);
    }

    .detailed-table .monthly-row {
      background: #f5f5f5;
      font-size: 12px;
      display: none;
    }

    .detailed-table .monthly-row.visible {
      display: table-row;
    }

    .detailed-table .monthly-row td {
      padding: 6px 8px;
      border-bottom: 1px dashed #e5e5e5;
    }

    .detailed-table .monthly-row:last-of-type td {
      border-bottom: 1px solid var(--ast-border-color);
    }

    .detailed-table .monthly-label {
      padding-left: 32px;
      color: var(--muted);
      font-size: 11px;
    }

    .detailed-summary {
      background: #fafafa;
      border: 1px solid var(--ast-border-color);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 24px;
    }

    .detailed-summary h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 12px;
    }

    .detailed-summary p {
      color: var(--muted);
      margin-bottom: 16px;
      font-size: 14px;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .summary-stat {
      display: flex;
      flex-direction: column;
    }

    .summary-stat-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .summary-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-dark);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Retirement Simulator</h1>
      <p>Test your retirement plan with Monte Carlo simulation across 1,000 market scenarios</p>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="portfolio">Portfolio</button>
      <button class="tab" data-tab="contributions">Contributions</button>
      <button class="tab" data-tab="retirement">Retirement</button>
      <button class="tab" data-tab="advanced">Advanced</button>
      <button class="tab" data-tab="historical">Historical</button>
      <button class="tab" data-tab="detailed">Detailed Outcome</button>
      <button class="tab" data-tab="failure" id="failureTab" style="display: none;">Detailed Failure</button>
    </div>

    <!-- Tab 1: Portfolio -->
    <div class="tab-content active" id="portfolio-tab">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Starting Balance</label>
          <input type="number" class="form-input" id="startingBalance" value="100000" min="0" step="1000">
          <div class="form-help">Current portfolio value</div>
        </div>

        <div class="form-group">
          <label class="form-label">Current Age</label>
          <input type="number" class="form-input" id="currentAge" value="30" min="18" max="100">
          <div class="form-help">Your age today</div>
        </div>
      </div>

      <h3 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin: 32px 0 16px;">Asset Allocation</h3>
      <p style="color: var(--muted); margin-bottom: 16px;">Allocate between stocks and bonds (must total 100%)</p>

      <table class="allocation-table">
        <thead>
          <tr>
            <th>Asset Class</th>
            <th>Allocation (%)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Stocks</td>
            <td><input type="number" class="allocation-input" data-ticker="STOCKS" value="70" min="0" max="100" step="1"></td>
          </tr>
          <tr>
            <td>Bonds</td>
            <td><input type="number" class="allocation-input" data-ticker="BONDS" value="30" min="0" max="100" step="1"></td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td class="allocation-total">Total</td>
            <td class="allocation-total"><span id="allocation-total">100</span>%</td>
          </tr>
        </tfoot>
      </table>

      <h3 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin: 32px 0 16px;">Investment Fees</h3>
      <p style="color: var(--muted); margin-bottom: 16px;">Annual fee charged by your advisor or platform</p>

      <div class="fee-selector">
        <label class="fee-option">
          <input type="radio" name="feeType" value="typical" class="fee-radio">
          <span class="fee-label">
            <span class="fee-title">Typical Advisor</span>
            <span class="fee-value">1.25% per year</span>
          </span>
        </label>

        <label class="fee-option">
          <input type="radio" name="feeType" value="arcvest" class="fee-radio" checked>
          <span class="fee-label">
            <span class="fee-title">ArcVest</span>
            <span class="fee-value">0.40% per year</span>
          </span>
        </label>

        <label class="fee-option">
          <input type="radio" name="feeType" value="custom" class="fee-radio">
          <span class="fee-label">
            <span class="fee-title">Custom</span>
            <span class="fee-value">Set your own</span>
          </span>
        </label>
      </div>

      <div class="form-group" id="customFeeGroup" style="display: none; margin-top: 16px; max-width: 300px;">
        <label class="form-label">Custom Fee (%)</label>
        <input type="number" class="form-input" id="customFee" value="1.00" min="0" max="5" step="0.01">
        <div class="form-help">Annual fee as a percentage</div>
      </div>
    </div>

    <!-- Tab 2: Contributions -->
    <div class="tab-content" id="contributions-tab">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Annual Contribution</label>
          <input type="number" class="form-input" id="annualContribution" value="10000" min="0" step="1000">
          <div class="form-help">Amount saved per year</div>
        </div>

        <div class="form-group">
          <label class="form-label">Contribution Growth Rate</label>
          <input type="number" class="form-input" id="contributionGrowth" value="3" min="0" max="10" step="0.1">
          <div class="form-help">Annual increase in contributions (%)</div>
        </div>

        <div class="form-group">
          <label class="form-label">Years of Contributions</label>
          <input type="number" class="form-input" id="yearsContributing" value="30" min="0" max="60" step="1">
          <div class="form-help">How many years will you save?</div>
        </div>
      </div>
    </div>

    <!-- Tab 3: Retirement -->
    <div class="tab-content" id="retirement-tab">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Retirement Age</label>
          <input type="number" class="form-input" id="retirementAge" value="65" min="40" max="100" step="1">
          <div class="form-help">Age when withdrawals begin</div>
        </div>

        <div class="form-group">
          <label class="form-label">Years in Retirement</label>
          <input type="number" class="form-input" id="yearsInRetirement" value="30" min="1" max="60" step="1">
          <div class="form-help">Planning horizon</div>
        </div>
      </div>

      <h3 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin: 32px 0 16px;">Withdrawal Strategy</h3>
      <p style="color: var(--muted); margin-bottom: 16px;">Choose how to determine your annual retirement spending</p>

      <div class="fee-selector">
        <label class="fee-option">
          <input type="radio" name="withdrawalType" value="fixed" class="withdrawal-type-radio">
          <span class="fee-label">
            <span class="fee-title">Fixed Amount</span>
            <span class="fee-value">Set a specific dollar amount</span>
          </span>
        </label>

        <label class="fee-option">
          <input type="radio" name="withdrawalType" value="percentage" class="withdrawal-type-radio" checked>
          <span class="fee-label">
            <span class="fee-title">% of Assets</span>
            <span class="fee-value">Percentage of portfolio at retirement</span>
          </span>
        </label>
      </div>

      <div class="form-grid" style="margin-top: 16px;">
        <div class="form-group" id="fixedWithdrawalGroup" style="display: none;">
          <label class="form-label">Annual Withdrawal</label>
          <input type="number" class="form-input" id="annualWithdrawal" value="40000" min="0" step="1000">
          <div class="form-help">Amount withdrawn per year</div>
        </div>

        <div class="form-group" id="percentageWithdrawalGroup">
          <label class="form-label">Withdrawal Rate (%)</label>
          <input type="number" class="form-input" id="withdrawalPercentage" value="4.0" min="0" max="20" step="0.1">
          <div class="form-help">4% is a common rule of thumb for sustainable withdrawals</div>
        </div>

        <div class="form-group">
          <label class="form-label">Withdrawal Inflation</label>
          <input type="number" class="form-input" id="withdrawalInflation" value="2.5" min="0" max="10" step="0.1">
          <div class="form-help">Annual increase in withdrawals (%)</div>
        </div>
      </div>

      <h4 style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin: 24px 0 12px;" id="guardrailsHeader">Guyton-Klinger Guardrails</h4>
      <div style="margin-bottom: 12px;" id="guardrailsToggleGroup">
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="checkbox" id="guardrailsEnabled" style="width: 18px; height: 18px; margin-right: 8px;">
          <span style="font-size: 14px; color: var(--text-dark);">Enable dynamic spending guardrails</span>
        </label>
      </div>
      <div class="form-grid" id="guardrailsGroup">
        <div class="form-group">
          <label class="form-label">Guardrail Band (%)</label>
          <input type="number" class="form-input guardrail-input" id="guardrailBand" value="20" min="0" max="50" step="1">
          <div class="form-help">Trigger threshold above/below initial rate</div>
        </div>

        <div class="form-group">
          <label class="form-label">Adjustment (%)</label>
          <input type="number" class="form-input guardrail-input" id="guardrailAdjustment" value="10" min="0" max="30" step="1">
          <div class="form-help">Spending cut or raise when triggered</div>
        </div>
      </div>
      <p style="color: var(--brand); font-size: 12px; margin-top: 8px; line-height: 1.5;" id="guardrailsExplanation">
        <strong>How guardrails work:</strong> Each year, if your current withdrawal rate rises above the initial rate × (1 + band), spending is cut by the adjustment %. If it falls below the initial rate × (1 − band), spending is raised. This helps preserve capital in down markets while allowing increases in good times.
      </p>
    </div>

    <!-- Tab 4: Advanced -->
    <div class="tab-content" id="advanced-tab">
      <h3 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin-bottom: 16px;">Simulation Settings</h3>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Simulation Count</label>
          <select class="form-select" id="simulationCount">
            <option value="100">100 scenarios (Fast)</option>
            <option value="500">500 scenarios</option>
            <option value="1000" selected>1,000 scenarios (Recommended)</option>
            <option value="5000">5,000 scenarios (Detailed)</option>
          </select>
          <div class="form-help">More scenarios = more accuracy</div>
        </div>

        <div class="form-group">
          <label class="form-label">Rebalancing</label>
          <select class="form-select" id="rebalancing">
            <option value="annual" selected>Annual Rebalancing</option>
            <option value="none">No Rebalancing</option>
          </select>
          <div class="form-help">Portfolio rebalancing strategy</div>
        </div>
      </div>

      <h3 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin: 32px 0 16px;">Expected Returns & Risk</h3>
      <p style="color: var(--muted); margin-bottom: 16px;">Set expected annual returns and volatility for each asset class</p>
      
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Stock Return (%/year)</label>
          <input type="number" class="form-input" id="stockReturn" value="8.0" min="0" max="20" step="0.1">
          <div class="form-help">Expected annual return</div>
        </div>

        <div class="form-group">
          <label class="form-label">Stock Volatility (%)</label>
          <input type="number" class="form-input" id="stockVolatility" value="17.0" min="0" max="50" step="0.1">
          <div class="form-help">Standard deviation (volatility)</div>
        </div>

        <div class="form-group">
          <label class="form-label">Bond Return (%/year)</label>
          <input type="number" class="form-input" id="bondReturn" value="4.5" min="0" max="20" step="0.1">
          <div class="form-help">Expected annual return</div>
        </div>

        <div class="form-group">
          <label class="form-label">Bond Volatility (%)</label>
          <input type="number" class="form-input" id="bondVolatility" value="7.0" min="0" max="50" step="0.1">
          <div class="form-help">Standard deviation (volatility)</div>
        </div>

        <div class="form-group">
          <label class="form-label">Correlation</label>
          <input type="number" class="form-input" id="correlation" value="0.2" min="-1" max="1" step="0.05">
          <div class="form-help">Correlation between stocks and bonds</div>
        </div>

        <div class="form-group">
          <label class="form-label">Degrees of Freedom</label>
          <input type="number" class="form-input" id="degreesOfFreedom" value="5" min="2" max="100" step="1">
          <div class="form-help">Fat tails: Use 5 for realistic extremes, 30+ for normal distribution</div>
        </div>

        <div class="form-group">
          <label class="form-label">Compound Annual Growth Rate (Before Fees)</label>
          <div id="expectedCAGR" style="padding: 10px 12px; background: #f8f9fa; border: 1px solid var(--ast-border-color); border-radius: 8px; font-size: 16px; font-weight: 600; color: var(--brand);">—</div>
          <div class="form-help">Expected median portfolio CAGR excluding fees</div>
        </div>
      </div>

      <h4 style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin: 24px 0 12px;">Simulation Mode</h4>
      <div class="fee-selector" style="margin-bottom: 16px;">
        <label class="fee-option">
          <input type="radio" name="simulationMode" value="simple" checked>
          <span class="fee-label">
            <span class="fee-title">Simple</span>
            <span class="fee-value">Single skewed-t distribution with your parameters above</span>
          </span>
        </label>
        <label class="fee-option">
          <input type="radio" name="simulationMode" value="regime-switching">
          <span class="fee-label">
            <span class="fee-title">Regime-Switching</span>
            <span class="fee-value">3-state Markov model: Calm, Crash, Inflation regimes</span>
          </span>
        </label>
      </div>

      <div id="simpleModelDescription" style="color: var(--muted); font-size: 12px; margin-top: 8px; line-height: 1.5;">
        <strong>Simple Distribution:</strong> Returns are sampled from a Skewed Student's t-distribution with negative skew (−0.3) to model fat tails and crash risk. Correlation is applied via Cholesky decomposition. At df ≥ 30, the distribution converges to normal.
      </div>

      <div id="regimeModelDescription" style="color: var(--muted); font-size: 12px; margin-top: 8px; line-height: 1.5; display: none;">
        <strong>Regime-Switching Model:</strong> A 3-state Markov model that captures realistic market dynamics:<br>
        • <strong>Calm</strong> (85% of time): Stocks 11%, Bonds 4.5%, correlation −0.25 (diversification works)<br>
        • <strong>Crash</strong> (10%): Stocks −20%, Bonds +10%, correlation −0.60 (flight to quality)<br>
        • <strong>Inflation</strong> (5%): Stocks 2%, Bonds −5%, correlation +0.50 (both struggle)<br>
        Regimes persist and transition based on calibrated probabilities. User inputs above are ignored.
      </div>

      <h3 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin: 32px 0 16px;">Taxes</h3>
      <p style="color: var(--muted); margin-bottom: 16px;">Model the impact of taxes on retirement withdrawals</p>
      
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Taxable Portion (%)</label>
          <input type="number" class="form-input" id="taxablePortion" value="75" min="0" max="100" step="1">
          <div class="form-help">Estimated taxable % of your portfolio</div>
        </div>

        <div class="form-group">
          <label class="form-label">Estimated Tax Rate (%)</label>
          <input type="number" class="form-input" id="taxRate" value="20" min="0" max="50" step="1">
          <div class="form-help">Estimate of blended tax rate for portfolio withdrawals</div>
        </div>
      </div>
    </div>

    <!-- Tab 5: Historical Scenarios -->
    <div class="tab-content" id="historical-tab">
      <h3 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">Historical Stress Test</h3>
      <p style="color: var(--muted); margin-bottom: 24px;">
        Test your retirement plan against historically bad times to retire. Select a scenario below to see how your portfolio
        would have performed using actual market returns from that period.
      </p>

      <div class="historical-scenarios" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">

        <div class="historical-card" data-scenario="1929-10" style="padding: 20px; border: 2px solid var(--ast-border-color); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; background: #fff;">
          <div style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">October 1929</div>
          <div style="font-size: 13px; color: var(--brand); font-weight: 600; margin-bottom: 8px;">The Great Depression</div>
          <div style="font-size: 13px; color: var(--muted); line-height: 1.5;">Stocks fell 89% over 3 years. One of the worst times in history to retire with a stock-heavy portfolio.</div>
        </div>

        <div class="historical-card" data-scenario="1966-01" style="padding: 20px; border: 2px solid var(--ast-border-color); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; background: #fff;">
          <div style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">January 1966</div>
          <div style="font-size: 13px; color: var(--brand); font-weight: 600; margin-bottom: 8px;">The Lost Decade(s)</div>
          <div style="font-size: 13px; color: var(--muted); line-height: 1.5;">Start of a 16-year secular bear market. Stocks went nowhere while inflation eroded purchasing power.</div>
        </div>

        <div class="historical-card" data-scenario="1973-01" style="padding: 20px; border: 2px solid var(--ast-border-color); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; background: #fff;">
          <div style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">January 1973</div>
          <div style="font-size: 13px; color: var(--brand); font-weight: 600; margin-bottom: 8px;">Oil Crisis & Stagflation</div>
          <div style="font-size: 13px; color: var(--muted); line-height: 1.5;">Stocks dropped 48% over 2 years. Stagflation meant both stocks AND bonds suffered.</div>
        </div>

        <div class="historical-card" data-scenario="2000-03" style="padding: 20px; border: 2px solid var(--ast-border-color); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; background: #fff;">
          <div style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">March 2000</div>
          <div style="font-size: 13px; color: var(--brand); font-weight: 600; margin-bottom: 8px;">Dot-Com Bubble Peak</div>
          <div style="font-size: 13px; color: var(--muted); line-height: 1.5;">Tech-heavy portfolios lost up to 80%. S&P 500 didn't recover for 13 years on a real basis.</div>
        </div>

        <div class="historical-card" data-scenario="2007-10" style="padding: 20px; border: 2px solid var(--ast-border-color); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; background: #fff;">
          <div style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">October 2007</div>
          <div style="font-size: 13px; color: var(--brand); font-weight: 600; margin-bottom: 8px;">Global Financial Crisis</div>
          <div style="font-size: 13px; color: var(--muted); line-height: 1.5;">Stocks fell 57% in 17 months. Retiring at the peak before the Great Recession was brutal.</div>
        </div>

        <div class="historical-card" data-scenario="2022-01" style="padding: 20px; border: 2px solid var(--ast-border-color); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; background: #fff;">
          <div style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">January 2022</div>
          <div style="font-size: 13px; color: var(--brand); font-weight: 600; margin-bottom: 8px;">Inflation Shock</div>
          <div style="font-size: 13px; color: var(--muted); line-height: 1.5;">Both stocks AND bonds fell together. A rare 60/40 portfolio disaster as Fed hiked rates.</div>
        </div>

        <div class="historical-card" id="customDateCard" data-scenario="custom" style="padding: 20px; border: 2px solid var(--ast-border-color); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; background: #fff;">
          <div style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">Custom Date</div>
          <div style="font-size: 13px; color: var(--brand); font-weight: 600; margin-bottom: 8px;">Choose Your Own</div>
          <div style="font-size: 13px; color: var(--muted); line-height: 1.5; margin-bottom: 12px;">Pick any month from January 1928 to December 2025.</div>
          <div style="display: flex; gap: 8px;" onclick="event.stopPropagation();">
            <select id="customHistoricalMonth" class="form-select" style="height: 36px; font-size: 14px; padding: 0 8px; flex: 1;">
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            <select id="customHistoricalYear" class="form-select" style="height: 36px; font-size: 14px; padding: 0 8px; flex: 1;">
            </select>
          </div>
        </div>

      </div>

      <div id="selectedScenarioInfo" style="display: none; padding: 16px; background: rgba(27, 156, 133, 0.05); border: 1px solid var(--brand); border-radius: var(--radius); margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 14px; color: var(--text-dark);"><strong>Selected:</strong> <span id="selectedScenarioName"></span></span>
          <button id="clearScenario" style="padding: 4px 12px; font-size: 12px; background: transparent; border: 1px solid var(--muted); border-radius: 4px; cursor: pointer; color: var(--muted);">Clear</button>
        </div>
      </div>

      <p style="color: var(--muted); font-size: 13px; line-height: 1.6;">
        <strong>How it works:</strong> Your portfolio grows normally until retirement using Monte Carlo simulation.
        At retirement, the simulation switches to actual historical returns from your selected scenario.
        If you outlive the historical data, Monte Carlo simulation resumes for the remaining years.
      </p>
    </div>

    <!-- Tab 6: Detailed Outcome -->
    <div class="tab-content" id="detailed-tab">
      <h3 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin-bottom: 16px;">Year-by-Year Breakdown</h3>
      <p style="color: var(--muted); margin-bottom: 16px;">
        After running the simulation, this tab will show the detailed year-by-year progression of the median scenario.
        The median scenario is the one that ranked 500th out of 1,000 simulations by final balance.
      </p>
      <div id="detailedOutcome">
        <p style="color: var(--muted); text-align: center; padding: 40px;">
          Run the simulation to see detailed year-by-year results
        </p>
      </div>
    </div>

    <!-- Tab 6: Detailed Failure (hidden by default, shown when there are failures) -->
    <div class="tab-content" id="failure-tab">
      <h3 style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin-bottom: 16px;">Median Failure Scenario</h3>
      <p style="color: var(--muted); margin-bottom: 16px;">
        This tab shows the year-by-year progression of the median failure scenario.
        Failed scenarios are ranked by when the money runs out, and this shows the median of those failures.
      </p>
      <div id="detailedFailure">
        <p style="color: var(--muted); text-align: center; padding: 40px;">
          Run the simulation to see failure scenario details (if any)
        </p>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-bar">
      <button class="btn btn-primary" id="runSimulation">Run Simulation</button>
      <button class="btn btn-secondary" id="resetForm">Reset to Defaults</button>
    </div>

    <!-- Results -->
    <div class="results" id="results">
      <h2 style="font-size: 18px;">Simulation Results</h2>

      <div class="results-grid">
        <div class="result-card">
          <div class="result-label">Success Rate</div>
          <div class="result-value" id="successRate">—</div>
        </div>

        <div class="result-card">
          <div class="result-label">Median Final Balance</div>
          <div class="result-value" id="medianBalance">—</div>
        </div>

        <div class="result-card">
          <div class="result-label">10th Percentile</div>
          <div class="result-value" id="percentile10">—</div>
        </div>

        <div class="result-card">
          <div class="result-label">90th Percentile</div>
          <div class="result-value" id="percentile90">—</div>
        </div>
      </div>

      <div class="chart-container">
        <h3>Portfolio Balance Over Time</h3>
        <canvas id="portfolioChart"></canvas>
      </div>

      <div class="chart-container">
        <h3 style="font-size: 18px;">What This Means For You</h3>
        <p id="whatThisMeans" style="color: var(--text); font-size: 14px; line-height: 1.5;"></p>
      </div>

      <div class="chart-container">
        <h3 style="font-size: 18px;">Distribution of Final Balances</h3>
        <canvas id="distributionChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Hidden static canvases for PDF generation -->
  <div style="display: none;">
    <canvas id="portfolioChartStatic" width="1600" height="800"></canvas>
    <canvas id="distributionChartStatic" width="1600" height="800"></canvas>
  </div>

  <!-- Email PDF Modal -->
  <div class="modal-overlay" id="emailPdfModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="emailPdfTitle">
      <button type="button" class="modal-close" id="emailPdfClose" aria-label="Close modal">&times;</button>
      <h3 id="emailPdfTitle">Download PDF</h3>
      <p class="modal-description">
        Please provide your email address and we will download and email you a detailed PDF of your Retirement Simulation Results.
      </p>
      <form id="emailPdfForm" novalidate>
        <div class="form-grid modal-form-grid">
          <div class="form-group">
            <label class="form-label" for="emailPdfEmail">Email</label>
            <input type="email" class="form-input" id="emailPdfEmail" name="email" placeholder="Email" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="emailPdfName">Name</label>
            <input type="text" class="form-input" id="emailPdfName" name="name" placeholder="Name" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="emailPdfLastName">Last name</label>
            <input type="text" class="form-input" id="emailPdfLastName" name="last_name" placeholder="Last name" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="emailPdfPhone">Phone</label>
            <input type="tel" class="form-input" id="emailPdfPhone" name="phone" placeholder="Phone">
          </div>
        </div>
        <button type="submit" class="btn btn-primary" id="sendPdfButton">Email PDF</button>
        <p class="modal-feedback" id="emailPdfFeedback" role="status" aria-live="polite"></p>
      </form>
    </div>
  </div>

  <script>
    function notifyParentHeight() {
      try {
        if (window.parent && window.parent !== window) {
          const height = document.documentElement.scrollHeight;
          window.parent.postMessage({ type: 'arcvest-simulator-size', height }, '*');
        }
      } catch (error) {
        console.warn('Unable to notify parent height', error);
      }
    }

    window.addEventListener('load', () => {
      setTimeout(notifyParentHeight, 50);
    });

    window.addEventListener('resize', () => {
      setTimeout(notifyParentHeight, 100);
    });

    window.addEventListener('message', (event) => {
      if (event?.data?.type === 'arcvest-request-size') {
        setTimeout(notifyParentHeight, 50);
      }
    });

    // State management
    let portfolioChart = null;
    let portfolioChartStatic = null;
    let distributionChart = null;
    let distributionChartStatic = null;
    let lastSimulationParams = null;
    let lastSimulationResults = null;
    let lastPortfolioChartImage = null;
    let lastDistributionChartImage = null;

    // Historical scenario descriptions for explanatory text
    const HISTORICAL_SCENARIO_INFO = {
      '1929-10': {
        name: 'Great Depression',
        date: 'October 1929',
        description: 'The Great Depression saw stocks fall 86% over 3 years, with deflation initially followed by a slow, grinding recovery that took until 1954 to fully recoup losses.'
      },
      '1966-01': {
        name: 'Lost Decades',
        date: 'January 1966',
        description: 'The "Lost Decades" featured high inflation, stagnant markets, and multiple recessions through 1982. After adjusting for inflation, stocks made no real gains for 16 years.'
      },
      '1973-01': {
        name: 'Oil Crisis & Stagflation',
        date: 'January 1973',
        description: 'The Oil Crisis brought stagflation—simultaneous high inflation and economic stagnation—with stocks falling 48% and bonds losing purchasing power to double-digit inflation.'
      },
      '2000-03': {
        name: 'Dot-Com Bubble',
        date: 'March 2000',
        description: 'The Dot-Com Bubble burst led to a 49% stock decline, and retirees faced a "lost decade" as markets were hit again by the 2008 financial crisis before recovering.'
      },
      '2007-10': {
        name: 'Global Financial Crisis',
        date: 'October 2007',
        description: 'The Global Financial Crisis saw stocks fall 57% in 17 months—the worst decline since the Depression—devastating portfolios just as many were beginning retirement.'
      },
      '2022-01': {
        name: 'Inflation Shock',
        date: 'January 2022',
        description: 'The 2022 Inflation Shock brought rapid interest rate hikes and simultaneous stock and bond losses—a rare double hit that hurt even diversified portfolios.'
      }
    };

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;

        // Update tab buttons
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');

        // Notify parent of height change after tab switch (with delay for DOM update)
        setTimeout(notifyParentHeight, 50);
      });
    });

    // Allocation tracking
    function updateAllocationTotal() {
      const inputs = document.querySelectorAll('.allocation-input');
      let total = 0;
      inputs.forEach(input => {
        total += parseFloat(input.value) || 0;
      });
      
      const totalElement = document.getElementById('allocation-total');
      totalElement.textContent = total;
      
      // Visual feedback
      const row = totalElement.parentElement;
      row.classList.remove('allocation-error', 'allocation-success');
      if (Math.abs(total - 100) < 0.01) {
        row.classList.add('allocation-success');
      } else {
        row.classList.add('allocation-error');
      }
      
      return total;
    }

    document.querySelectorAll('.allocation-input').forEach(input => {
      input.addEventListener('input', updateAllocationTotal);
    });

    // Fee selection handling
    function getFeePercentage() {
      const feeType = document.querySelector('input[name="feeType"]:checked').value;

      if (feeType === 'typical') {
        return 1.25;
      } else if (feeType === 'arcvest') {
        return 0.40;
      } else if (feeType === 'custom') {
        const customValue = parseFloat(document.getElementById('customFee').value);
        // Use isNaN check instead of || to allow 0 as a valid value
        return Number.isNaN(customValue) ? 1.00 : customValue;
      }
      return 0.40; // Default to ArcVest
    }

    // Show/hide custom fee input
    document.querySelectorAll('input[name="feeType"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const customFeeGroup = document.getElementById('customFeeGroup');
        if (e.target.value === 'custom') {
          customFeeGroup.style.display = 'block';
        } else {
          customFeeGroup.style.display = 'none';
        }
        updateExpectedCAGR();
      });
    });

    // Random number generation for Monte Carlo CAGR estimation
    // Box-Muller transform for standard normal
    function mcRandomNormal() {
      let u1 = 0, u2 = 0;
      while (u1 === 0) u1 = Math.random();
      while (u2 === 0) u2 = Math.random();
      return Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
    }

    // Student's t-distribution
    function mcRandomT(df) {
      const z = mcRandomNormal();
      let chiSq = 0;
      for (let i = 0; i < df; i++) {
        const n = mcRandomNormal();
        chiSq += n * n;
      }
      if (df > 2) {
        return z / Math.sqrt(chiSq / df) * Math.sqrt((df - 2) / df);
      }
      return z / Math.sqrt(chiSq / df);
    }

    // Skewed Student's t-distribution (matches API implementation)
    function mcRandomSkewedT(df, skew) {
      const t = mcRandomT(df);
      if (isNaN(t)) return 0;

      let skewed;
      if (t < 0) {
        skewed = t * (1 + Math.abs(skew));
      } else {
        skewed = t * (1 - Math.abs(skew) * 0.5);
      }
      const meanCorrection = 0.18 * Math.abs(skew) / 0.3;
      return skewed + meanCorrection;
    }

    // Generate correlated returns using Cholesky decomposition
    function mcGenerateCorrelatedReturns(mean1, std1, mean2, std2, correlation, df) {
      const skewness = -0.3;
      const z1 = df < 30 ? mcRandomSkewedT(df, skewness) : mcRandomNormal();
      const z2 = df < 30 ? mcRandomSkewedT(df, skewness) : mcRandomNormal();

      const correlationFactor = Math.abs(correlation) < 0.999 ? Math.sqrt(1 - correlation * correlation) : 0;
      const return1 = mean1 + std1 * z1;
      const return2 = mean2 + std2 * (correlation * z1 + correlationFactor * z2);

      return [return1, return2];
    }

    // Calculate median CAGR using Monte Carlo simulation
    function updateExpectedCAGR() {
      try {
        // Get allocations (as decimals)
        const stockAlloc = (parseFloat(document.querySelector('[data-ticker="STOCKS"]')?.value) || 0) / 100;
        const bondAlloc = (parseFloat(document.querySelector('[data-ticker="BONDS"]')?.value) || 0) / 100;

        // Get returns and volatilities (as decimals)
        const stockReturn = (parseFloat(document.getElementById('stockReturn')?.value) || 0) / 100;
        const bondReturn = (parseFloat(document.getElementById('bondReturn')?.value) || 0) / 100;
        const stockVol = (parseFloat(document.getElementById('stockVolatility')?.value) || 0) / 100;
        const bondVol = (parseFloat(document.getElementById('bondVolatility')?.value) || 0) / 100;
        const correlation = parseFloat(document.getElementById('correlation')?.value) || 0;
        const df = parseFloat(document.getElementById('degreesOfFreedom')?.value) || 5;

        // Convert to monthly values
        const monthlyStockReturn = stockReturn / 12;
        const monthlyBondReturn = bondReturn / 12;
        const monthlyStockVol = stockVol / Math.sqrt(12);
        const monthlyBondVol = bondVol / Math.sqrt(12);

        // Run Monte Carlo simulation (1000 scenarios, 600 months / 50 years each)
        const numSimulations = 1000;
        const numMonths = 600;
        const numYears = numMonths / 12;
        const cagrs = [];

        for (let sim = 0; sim < numSimulations; sim++) {
          let balance = 1.0; // Start with $1

          for (let month = 0; month < numMonths; month++) {
            // Generate correlated monthly returns
            const [stockRet, bondRet] = mcGenerateCorrelatedReturns(
              monthlyStockReturn, monthlyStockVol,
              monthlyBondReturn, monthlyBondVol,
              correlation, df
            );

            // Apply weighted portfolio return (before fees)
            const portfolioReturn = stockAlloc * stockRet + bondAlloc * bondRet;
            balance *= (1 + portfolioReturn);
          }

          // Calculate CAGR for this 50-year simulation
          // CAGR = (ending/starting)^(1/years) - 1
          const cagr = Math.pow(balance, 1 / numYears) - 1;
          cagrs.push(cagr);
        }

        // Find median CAGR
        cagrs.sort((a, b) => a - b);
        const medianReturn = cagrs[Math.floor(numSimulations / 2)];

        // Display as percentage
        const cagrDisplay = document.getElementById('expectedCAGR');
        if (cagrDisplay) {
          cagrDisplay.textContent = (medianReturn * 100).toFixed(2) + '%';
          cagrDisplay.style.color = medianReturn >= 0 ? 'var(--brand)' : '#dc2626';
        }
      } catch (error) {
        console.error('Error calculating expected CAGR:', error);
        const cagrDisplay = document.getElementById('expectedCAGR');
        if (cagrDisplay) cagrDisplay.textContent = '—';
      }
    }

    // Wire up CAGR updates to all relevant inputs (before fees, so no fee input)
    ['stockReturn', 'bondReturn', 'stockVolatility', 'bondVolatility',
     'correlation', 'degreesOfFreedom'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', updateExpectedCAGR);
    });

    // Also update CAGR when allocation changes
    document.querySelectorAll('.allocation-input').forEach(input => {
      input.addEventListener('input', updateExpectedCAGR);
    });

    // Also update CAGR when fee type changes (handled above in radio listener)

    // Show/hide withdrawal type inputs and enable/disable guardrails
    function updateGuardrailsState(isPercentage) {
      const guardrailsHeader = document.getElementById('guardrailsHeader');
      const guardrailsToggleGroup = document.getElementById('guardrailsToggleGroup');
      const guardrailsGroup = document.getElementById('guardrailsGroup');
      const guardrailsExplanation = document.getElementById('guardrailsExplanation');
      const guardrailInputs = document.querySelectorAll('.guardrail-input');
      const guardrailsEnabledCheckbox = document.getElementById('guardrailsEnabled');

      if (isPercentage) {
        // Enable the guardrails section (toggle is available)
        guardrailsHeader.style.opacity = '1';
        guardrailsToggleGroup.style.opacity = '1';
        guardrailsEnabledCheckbox.disabled = false;

        // Band/adjustment inputs depend on toggle state
        const isEnabled = guardrailsEnabledCheckbox.checked;
        guardrailsGroup.style.opacity = isEnabled ? '1' : '0.5';
        guardrailsExplanation.style.opacity = isEnabled ? '1' : '0.5';
        guardrailInputs.forEach(input => {
          input.disabled = !isEnabled;
          input.style.backgroundColor = isEnabled ? '' : '#f0f0f0';
        });
      } else {
        // Disable entire guardrails section (grayed out)
        guardrailsHeader.style.opacity = '0.5';
        guardrailsToggleGroup.style.opacity = '0.5';
        guardrailsGroup.style.opacity = '0.5';
        guardrailsExplanation.style.opacity = '0.5';
        guardrailsEnabledCheckbox.disabled = true;
        guardrailInputs.forEach(input => {
          input.disabled = true;
          input.style.backgroundColor = '#f0f0f0';
        });
      }
    }

    // Handle guardrails toggle checkbox
    document.getElementById('guardrailsEnabled').addEventListener('change', () => {
      const isPercentage = document.querySelector('input[name="withdrawalType"]:checked')?.value === 'percentage';
      updateGuardrailsState(isPercentage);
    });

    document.querySelectorAll('input[name="withdrawalType"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const fixedGroup = document.getElementById('fixedWithdrawalGroup');
        const percentageGroup = document.getElementById('percentageWithdrawalGroup');
        const isPercentage = e.target.value === 'percentage';

        if (isPercentage) {
          fixedGroup.style.display = 'none';
          percentageGroup.style.display = 'block';
        } else {
          fixedGroup.style.display = 'block';
          percentageGroup.style.display = 'none';
        }

        updateGuardrailsState(isPercentage);
      });
    });

    // Initialize guardrails state based on default selection
    updateGuardrailsState(document.querySelector('input[name="withdrawalType"]:checked')?.value === 'percentage');

    // Show/hide simulation mode descriptions and enable/disable simple model inputs
    function updateSimulationModeState(isRegimeSwitching) {
      const simpleDesc = document.getElementById('simpleModelDescription');
      const regimeDesc = document.getElementById('regimeModelDescription');
      const simpleInputIds = ['stockReturn', 'stockVolatility', 'bondReturn', 'bondVolatility', 'correlation', 'degreesOfFreedom'];

      if (isRegimeSwitching) {
        // Show regime description, hide simple
        simpleDesc.style.display = 'none';
        regimeDesc.style.display = 'block';
        // Gray out simple model inputs
        simpleInputIds.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.disabled = true;
            el.style.backgroundColor = '#f0f0f0';
            el.style.opacity = '0.6';
          }
        });
      } else {
        // Show simple description, hide regime
        simpleDesc.style.display = 'block';
        regimeDesc.style.display = 'none';
        // Enable simple model inputs
        simpleInputIds.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.disabled = false;
            el.style.backgroundColor = '';
            el.style.opacity = '';
          }
        });
      }
    }

    document.querySelectorAll('input[name="simulationMode"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        updateSimulationModeState(e.target.value === 'regime-switching');
        // Notify parent of height change after content change
        setTimeout(notifyParentHeight, 50);
      });
    });

    // Initialize simulation mode state based on default selection
    updateSimulationModeState(document.querySelector('input[name="simulationMode"]:checked')?.value === 'regime-switching');

    // Historical scenario selection
    let selectedHistoricalScenario = null;

    const historicalScenarioNames = {
      '1929-10': 'October 1929 - The Great Depression',
      '1966-01': 'January 1966 - The Lost Decade(s)',
      '1973-01': 'January 1973 - Oil Crisis & Stagflation',
      '2000-03': 'March 2000 - Dot-Com Bubble Peak',
      '2007-10': 'October 2007 - Global Financial Crisis',
      '2022-01': 'January 2022 - Inflation Shock'
    };

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];

    // Populate custom year dropdown (1928-2025)
    const yearSelect = document.getElementById('customHistoricalYear');
    for (let year = 1928; year <= 2025; year++) {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year;
      yearSelect.appendChild(option);
    }
    yearSelect.value = '1928'; // Default to earliest year

    // Helper to get custom date scenario name
    function getCustomScenarioName() {
      const month = document.getElementById('customHistoricalMonth').value;
      const year = document.getElementById('customHistoricalYear').value;
      const monthName = monthNames[parseInt(month) - 1];
      return `${monthName} ${year} - Custom Date`;
    }

    // Helper to get custom date scenario key
    function getCustomScenarioKey() {
      const month = document.getElementById('customHistoricalMonth').value;
      const year = document.getElementById('customHistoricalYear').value;
      return `${year}-${month}`;
    }

    document.querySelectorAll('.historical-card').forEach(card => {
      card.addEventListener('click', () => {
        const scenario = card.dataset.scenario;

        // For custom card, get the actual date from dropdowns
        const actualScenario = scenario === 'custom' ? getCustomScenarioKey() : scenario;
        const scenarioName = scenario === 'custom' ? getCustomScenarioName() : historicalScenarioNames[scenario];

        // Toggle selection
        if (selectedHistoricalScenario === actualScenario && card.classList.contains('selected')) {
          // Deselect if clicking the same card
          selectedHistoricalScenario = null;
          card.classList.remove('selected');
          document.getElementById('selectedScenarioInfo').style.display = 'none';
        } else {
          // Select new card
          document.querySelectorAll('.historical-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedHistoricalScenario = actualScenario;
          document.getElementById('selectedScenarioName').textContent = scenarioName;
          document.getElementById('selectedScenarioInfo').style.display = 'block';
        }
      });
    });

    // Update custom scenario when dropdowns change (if custom card is selected)
    document.getElementById('customHistoricalMonth').addEventListener('change', () => {
      const customCard = document.getElementById('customDateCard');
      if (customCard.classList.contains('selected')) {
        selectedHistoricalScenario = getCustomScenarioKey();
        document.getElementById('selectedScenarioName').textContent = getCustomScenarioName();
      }
    });

    document.getElementById('customHistoricalYear').addEventListener('change', () => {
      const customCard = document.getElementById('customDateCard');
      if (customCard.classList.contains('selected')) {
        selectedHistoricalScenario = getCustomScenarioKey();
        document.getElementById('selectedScenarioName').textContent = getCustomScenarioName();
      }
    });

    document.getElementById('clearScenario').addEventListener('click', () => {
      selectedHistoricalScenario = null;
      document.querySelectorAll('.historical-card').forEach(c => c.classList.remove('selected'));
      document.getElementById('selectedScenarioInfo').style.display = 'none';
    });

    // Reset form
    document.getElementById('resetForm').addEventListener('click', () => {
      if (confirm('Reset all inputs to default values?')) {
        document.getElementById('startingBalance').value = 100000;
        document.getElementById('currentAge').value = 30;
        document.getElementById('annualContribution').value = 10000;
        document.getElementById('contributionGrowth').value = 3;
        document.getElementById('yearsContributing').value = 30;
        document.getElementById('retirementAge').value = 65;
        document.getElementById('annualWithdrawal').value = 40000;
        document.getElementById('withdrawalInflation').value = 2.5;
        document.getElementById('yearsInRetirement').value = 30;
        document.getElementById('simulationCount').value = 1000;
        document.getElementById('rebalancing').value = 'annual';
        
        document.querySelector('[data-ticker="STOCKS"]').value = 70;
        document.querySelector('[data-ticker="BONDS"]').value = 30;
        
        document.getElementById('stockReturn').value = 8.0;
        document.getElementById('stockVolatility').value = 17.0;
        document.getElementById('bondReturn').value = 4.5;
        document.getElementById('bondVolatility').value = 7.0;
        document.getElementById('correlation').value = 0.2;
        document.getElementById('degreesOfFreedom').value = 5;
        document.getElementById('taxablePortion').value = 75;
        document.getElementById('taxRate').value = 20;
        
        // Reset fee selection to ArcVest
        document.querySelector('input[name="feeType"][value="arcvest"]').checked = true;
        document.getElementById('customFeeGroup').style.display = 'none';
        document.getElementById('customFee').value = 1.00;

        // Reset withdrawal type to % of Assets
        document.querySelector('input[name="withdrawalType"][value="percentage"]').checked = true;
        document.getElementById('fixedWithdrawalGroup').style.display = 'none';
        document.getElementById('percentageWithdrawalGroup').style.display = 'block';
        document.getElementById('withdrawalPercentage').value = 4.0;

        // Reset guardrails
        document.getElementById('guardrailsEnabled').checked = false;
        document.getElementById('guardrailBand').value = 20;
        document.getElementById('guardrailAdjustment').value = 10;
        updateGuardrailsState(true);

        // Reset simulation mode to Simple
        document.querySelector('input[name="simulationMode"][value="simple"]').checked = true;
        updateSimulationModeState(false);

        // Reset historical scenario
        selectedHistoricalScenario = null;
        document.querySelectorAll('.historical-card').forEach(c => c.classList.remove('selected'));
        document.getElementById('selectedScenarioInfo').style.display = 'none';

        updateAllocationTotal();
        updateExpectedCAGR();
      }
    });

    // Run simulation
    document.getElementById('runSimulation').addEventListener('click', async () => {
      // Validate allocation
      const total = updateAllocationTotal();
      if (Math.abs(total - 100) > 0.01) {
        alert('Asset allocation must total 100%');
        return;
      }

      // Collect allocation - include 0% allocations!
      const allocation = {};
      document.querySelectorAll('.allocation-input').forEach(input => {
        const ticker = input.dataset.ticker;
        const value = parseFloat(input.value) || 0;
        allocation[ticker] = value;  // Include even if 0!
      });

      // Collect parameters
      const withdrawalType = document.querySelector('input[name="withdrawalType"]:checked').value;
      const params = {
        startingBalance: parseFloat(document.getElementById('startingBalance').value),
        currentAge: parseInt(document.getElementById('currentAge').value),
        retirementAge: parseInt(document.getElementById('retirementAge').value),
        annualContribution: parseFloat(document.getElementById('annualContribution').value),
        contributionGrowth: parseFloat(document.getElementById('contributionGrowth').value) / 100,
        yearsContributing: parseInt(document.getElementById('yearsContributing').value),
        annualWithdrawal: parseFloat(document.getElementById('annualWithdrawal').value),
        withdrawalType: withdrawalType,
        withdrawalPercentage: parseFloat(document.getElementById('withdrawalPercentage').value) / 100,
        // Guardrails (only used when withdrawalType is 'percentage' AND toggle is enabled)
        guardrailBand: (withdrawalType === 'percentage' && document.getElementById('guardrailsEnabled').checked) ? parseFloat(document.getElementById('guardrailBand').value) / 100 : 0,
        guardrailAdjustment: (withdrawalType === 'percentage' && document.getElementById('guardrailsEnabled').checked) ? parseFloat(document.getElementById('guardrailAdjustment').value) / 100 : 0,
        withdrawalInflation: parseFloat(document.getElementById('withdrawalInflation').value) / 100,
        yearsInRetirement: parseInt(document.getElementById('yearsInRetirement').value),
        simulationCount: parseInt(document.getElementById('simulationCount').value),
        rebalancing: document.getElementById('rebalancing').value,
        allocation,
        // Expected returns and volatility
        stockReturn: parseFloat(document.getElementById('stockReturn').value) / 100,
        stockVolatility: parseFloat(document.getElementById('stockVolatility').value) / 100,
        bondReturn: parseFloat(document.getElementById('bondReturn').value) / 100,
        bondVolatility: parseFloat(document.getElementById('bondVolatility').value) / 100,
        correlation: parseFloat(document.getElementById('correlation').value),
        degreesOfFreedom: parseFloat(document.getElementById('degreesOfFreedom').value),
        // Taxes
        taxablePortion: parseFloat(document.getElementById('taxablePortion').value) / 100,
        taxRate: parseFloat(document.getElementById('taxRate').value) / 100,
        // Investment fees
        investmentFee: getFeePercentage() / 100,
        // Simulation mode
        simulationMode: document.querySelector('input[name="simulationMode"]:checked').value,
        // Historical scenario (if selected)
        historicalScenario: selectedHistoricalScenario
      };

      lastSimulationParams = params;
      lastSimulationResults = null;
      lastPortfolioChartImage = null;
      lastDistributionChartImage = null;

      // Show loading
      const resultsDiv = document.getElementById('results');
      resultsDiv.classList.add('visible');
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Running Monte Carlo simulation...</p></div>';

      requestAnimationFrame(() => {
        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });

      try {
        // Call API
        const response = await fetch('/api/retirement/simulate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });

        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();
        displayResults(data);
      } catch (error) {
        console.error('Simulation error:', error);
        resultsDiv.innerHTML = `<div class="alert alert-error">Error running simulation: ${error.message}</div>`;
      }
    });

    function displayResults(data) {
      const successRate = (data.successRate * 100).toFixed(1);
      const successRateNum = data.successRate * 100;
      const successClass = data.successRate >= 0.9 ? 'success' : data.successRate >= 0.7 ? 'warning' : 'danger';
      const params = lastSimulationParams;

      // Determine scenario type
      const isHistorical = params && params.historicalScenario;
      const historicalInfo = isHistorical ? HISTORICAL_SCENARIO_INFO[params.historicalScenario] : null;
      const yearsToRetirement = params ? (params.retirementAge - params.currentAge) : 0;
      const yearsInRetirement = params ? params.yearsInRetirement : 30;
      const isImmediateRetirement = yearsToRetirement <= 0;
      const totalYears = yearsToRetirement + yearsInRetirement;

      // Calculate median savings at retirement and first year withdrawal from medianSimulationDetails
      let medianSavingsAtRetirement = params ? params.startingBalance : 0;
      let firstYearWithdrawal = 0;
      if (data.medianSimulationDetails && data.medianSimulationDetails.length > 0) {
        // Find the year where retirement starts (first year with withdrawals > 0)
        const retirementYearIndex = data.medianSimulationDetails.findIndex(y => y.withdrawalGross > 0);
        if (retirementYearIndex > 0) {
          // Use the end balance of the year before retirement
          medianSavingsAtRetirement = data.medianSimulationDetails[retirementYearIndex - 1].endBalance;
        } else if (retirementYearIndex === 0) {
          // Immediate retirement - use starting balance
          medianSavingsAtRetirement = params ? params.startingBalance : data.medianSimulationDetails[0].startBalance || 0;
        }
        // Get first year withdrawal
        const firstRetirementYear = data.medianSimulationDetails.find(y => y.withdrawalGross > 0);
        if (firstRetirementYear) {
          firstYearWithdrawal = firstRetirementYear.withdrawalGross;
        }
      }

      // Build scenario banner
      let scenarioBanner = '';
      if (isHistorical && historicalInfo) {
        const scenarioTitle = `Historical Stress Test: ${historicalInfo.name}`;
        let scenarioDesc = '';
        if (isImmediateRetirement) {
          scenarioDesc = `All ${yearsInRetirement} years use actual historical returns starting ${historicalInfo.date}.`;
        } else {
          scenarioDesc = `Pre-retirement: ${yearsToRetirement} years simulated with randomized returns. Retirement: ${yearsInRetirement} years of actual historical returns starting ${historicalInfo.date}.`;
        }
        scenarioBanner = `
          <div class="scenario-banner scenario-historical">
            <div class="scenario-type">
              <span class="scenario-title">${scenarioTitle}</span>
            </div>
            <div class="scenario-description">${scenarioDesc}</div>
          </div>
        `;
      } else {
        scenarioBanner = `
          <div class="scenario-banner scenario-montecarlo">
            <div class="scenario-type">
              <span class="scenario-title">Monte Carlo Simulation</span>
            </div>
            <div class="scenario-description">Results based on 1,000 randomized scenarios using expected returns and volatility across all ${totalYears} years.</div>
          </div>
        `;
      }

      // Build scenario summary section
      const stockAlloc = params ? (params.allocation?.STOCKS || 0) : 70;
      const bondAlloc = params ? (params.allocation?.BONDS || 0) : 30;
      const contributionText = yearsToRetirement > 0
        ? `Beginning at age ${params.currentAge}, contribute ${formatCurrency(params.annualContribution)} per year for ${params.yearsContributing} years, increasing ${(params.contributionGrowth * 100).toFixed(1)}% annually with inflation.`
        : `No contribution period (retiring immediately).`;

      // Build withdrawal description based on type
      let withdrawalDesc = '';
      if (params.withdrawalType === 'percentage') {
        const pct = (params.withdrawalPercentage * 100).toFixed(1);
        if (params.guardrailBand > 0) {
          const band = (params.guardrailBand * 100).toFixed(0);
          const adj = (params.guardrailAdjustment * 100).toFixed(0);
          withdrawalDesc = `Withdraw ${pct}% of portfolio value each year with Guyton-Klinger guardrails (±${band}% band, ${adj}% adjustment). Spending automatically adjusts if withdrawal rate drifts too far from ${pct}%.`;
        } else {
          withdrawalDesc = `Withdraw ${pct}% of portfolio value each year. As the portfolio grows or shrinks, withdrawals adjust accordingly.`;
        }
      } else {
        withdrawalDesc = `Withdraw a fixed ${formatCurrency(params.annualWithdrawal)} per year, increasing ${(params.withdrawalInflation * 100).toFixed(1)}% annually with inflation.`;
      }

      // Build market outcomes description
      let marketDesc = '';
      if (isHistorical && historicalInfo) {
        if (isImmediateRetirement) {
          marketDesc = `<strong>Deterministic:</strong> All ${yearsInRetirement} retirement years use actual historical returns from ${historicalInfo.date}. This shows exactly what would have happened had you retired at that date.`;
        } else {
          marketDesc = `<strong>Hybrid:</strong> Pre-retirement (${yearsToRetirement} years) uses randomized Monte Carlo returns. Retirement (${yearsInRetirement} years) uses actual historical returns starting ${historicalInfo.date}. Inflation during retirement uses actual historical CPI.`;
        }
      } else {
        if (params.simulationMode === 'regime') {
          marketDesc = `<strong>Regime-Switching Model:</strong> Returns are generated using a 3-state Markov model with Calm (85%), Crash (10%), and Inflation (5%) regimes. Each regime has calibrated returns, volatility, and correlation. This captures realistic market dynamics including volatility clustering and correlation regime changes.`;
        } else {
          marketDesc = `<strong>Monte Carlo:</strong> 1,000 scenarios with randomized returns drawn from a skewed Student's t-distribution. Expected stock return: ${(params.stockReturn * 100).toFixed(1)}%, expected bond return: ${(params.bondReturn * 100).toFixed(1)}%. Correlation: ${params.correlation.toFixed(2)}.`;
        }
      }

      const scenarioSummary = `
        <div class="scenario-summary">
          <h3>Scenario Being Tested</h3>
          <div class="scenario-grid">
            <div class="scenario-item">
              <div class="scenario-item-label">Portfolio</div>
              <div class="scenario-item-value"><strong>${formatCurrency(params.startingBalance)}</strong> at age ${params.currentAge}, allocated ${stockAlloc}% stocks / ${bondAlloc}% bonds.</div>
            </div>
            <div class="scenario-item">
              <div class="scenario-item-label">Contributions</div>
              <div class="scenario-item-value">${contributionText}</div>
            </div>
            <div class="scenario-item">
              <div class="scenario-item-label">Withdrawals</div>
              <div class="scenario-item-value">Begin at age ${params.retirementAge} for ${yearsInRetirement} years. ${withdrawalDesc}</div>
            </div>
            <div class="scenario-item">
              <div class="scenario-item-label">Market Outcomes</div>
              <div class="scenario-item-value">${marketDesc}</div>
            </div>
          </div>
        </div>
      `;

      // Build explanation text
      const successRounded = Math.round(successRateNum);
      const riskPercent = Math.max(0, 100 - successRounded);

      // Paragraph 1: What happened (narrative)
      let para1 = `<strong>What This Simulation Did:</strong> `;
      if (yearsToRetirement > 0) {
        para1 += `Starting with ${formatCurrency(params.startingBalance)} at age ${params.currentAge}, you saved for ${yearsToRetirement} years. In the median scenario, your portfolio grew to <strong>${formatCurrency(medianSavingsAtRetirement)}</strong> by retirement at age ${params.retirementAge}. `;
      } else {
        para1 += `Starting with ${formatCurrency(params.startingBalance)} at age ${params.currentAge} (immediate retirement). `;
      }
      if (params.withdrawalType === 'percentage') {
        const pct = (params.withdrawalPercentage * 100).toFixed(1);
        para1 += `You then began withdrawing ${pct}% of your portfolio annually. In the first year, this was <strong>${formatCurrency(firstYearWithdrawal)}</strong>. `;
        if (params.guardrailBand > 0) {
          para1 += `Guyton-Klinger guardrails automatically adjusted spending when withdrawal rates drifted too high or low. `;
        }
      } else {
        para1 += `You then began withdrawing ${formatCurrency(params.annualWithdrawal)}/year (growing with inflation). In the first year, this was <strong>${formatCurrency(firstYearWithdrawal)}</strong>. `;
      }
      para1 += `After ${yearsInRetirement} years of retirement, the simulation tracked how much money remained.`;

      // Paragraph 2: Success Rate
      let para2 = `<strong>Success Rate:</strong> Your success rate of <strong>${successRounded}%</strong> means that in ${successRounded * 10} out of 1,000 simulated scenarios, your retirement savings lasted through your entire ${yearsInRetirement}-year retirement period. `;
      if (successRateNum >= 90) {
        para2 += `A success rate above 90% is generally considered comfortable for retirement planning.`;
      } else if (successRateNum >= 80) {
        para2 += `While reasonable, some advisors recommend targeting 90%+ for added peace of mind.`;
      } else if (successRateNum >= 70) {
        para2 += `This suggests moderate risk—there's a ${riskPercent}% chance you could outlive your savings.`;
      } else {
        para2 += `This indicates significant risk of running out of money. We recommend reviewing your plan.`;
      }
      // Special note for full historical scenarios with percentage withdrawals
      if (isHistorical && isImmediateRetirement && params.withdrawalType === 'percentage' && yearsInRetirement >= 30) {
        para2 += ` <em>Note: With a full historical scenario using percentage-based withdrawals over ${yearsInRetirement}+ years, you typically see 0% or 100% success because all 1,000 scenarios use the same historical returns—they either all succeed or all fail.</em>`;
      }

      // Paragraph 3: Range of Outcomes
      let para3 = `<strong>Range of Outcomes:</strong> The 20th percentile (${formatCurrency(data.percentile20)}) represents a challenging scenario—only 20% of simulations ended with less. The median (${formatCurrency(data.medianBalance)}) is your most likely outcome. The 80th percentile (${formatCurrency(data.percentile80)}) shows favorable conditions. The spread reflects market uncertainty over ${totalYears} years.`;

      // Paragraph 4: Key Factors
      let para4 = `<strong>Key Factors:</strong> Your results depend on your withdrawal approach (`;
      if (params.withdrawalType === 'percentage') {
        para4 += `${(params.withdrawalPercentage * 100).toFixed(1)}% of assets${params.guardrailBand > 0 ? ' with guardrails' : ''}`;
      } else {
        para4 += `fixed ${formatCurrency(params.annualWithdrawal)}/year`;
      }
      para4 += `), asset allocation (${stockAlloc}/${bondAlloc} stocks/bonds), investment returns, and inflation. `;
      if (successRateNum < 80) {
        para4 += `Given your ${successRounded}% success rate, small changes could help—retiring a year later, reducing spending, or adjusting allocation. <strong>We recommend consulting an advisor.</strong>`;
      } else if (successRateNum < 90) {
        para4 += `To push toward 90%+, consider slightly reducing withdrawals or extending working years.`;
      } else {
        para4 += `Your plan appears on solid footing. Continue to monitor as circumstances change.`;
      }
      if (isHistorical) {
        para4 += ` Note: This stress test uses a historically difficult period—actual future results will differ.`;
      }

      // Paragraph 5: Historical Context (only for historical scenarios)
      let para5 = '';
      if (isHistorical && historicalInfo) {
        para5 = `<strong>Historical Context:</strong> ${historicalInfo.description} This stress test helps you understand whether your plan could withstand similar conditions.`;
      }

      // Build secondary metrics
      const medianIRR = (data.medianIRR !== undefined && !isNaN(data.medianIRR)) ? data.medianIRR.toFixed(1) + '%' : 'N/A';
      const medianVol = (data.medianVolatility !== undefined && !isNaN(data.medianVolatility)) ? data.medianVolatility.toFixed(1) + '%' : 'N/A';
      const stockMedian = (data.stockReturnDistribution && data.stockReturnDistribution.length > 0) ? calculateMedian(data.stockReturnDistribution).toFixed(1) + '%' : 'N/A';
      const stockRange = (data.stockReturnDistribution && data.stockReturnDistribution.length > 0) ? `${calculatePercentile(data.stockReturnDistribution, 0.2).toFixed(1)}% to ${calculatePercentile(data.stockReturnDistribution, 0.8).toFixed(1)}%` : 'N/A';
      const bondMedian = (data.bondReturnDistribution && data.bondReturnDistribution.length > 0) ? calculateMedian(data.bondReturnDistribution).toFixed(1) + '%' : 'N/A';
      const bondRange = (data.bondReturnDistribution && data.bondReturnDistribution.length > 0) ? `${calculatePercentile(data.bondReturnDistribution, 0.2).toFixed(1)}% to ${calculatePercentile(data.bondReturnDistribution, 0.8).toFixed(1)}%` : 'N/A';

      // Rebuild entire results HTML
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `
        <div class="results-header">
          <h2>Simulation Results</h2>
          <button class="btn btn-primary email-pdf-button" id="emailPdfTrigger">Email PDF</button>
        </div>

        ${scenarioBanner}

        ${scenarioSummary}

        <div class="explanation-section">
          <div class="explanation-header" onclick="toggleExplanation()">
            <span class="explanation-title">Understanding Your Results</span>
            <button class="collapse-toggle" id="explanationToggle" aria-expanded="true">▼</button>
          </div>
          <div class="explanation-content" id="explanationContent">
            <p class="explanation-para">${para1}</p>
            <p class="explanation-para">${para2}</p>
            <p class="explanation-para">${para3}</p>
            <p class="explanation-para">${para4}</p>
            ${para5 ? `<p class="explanation-para">${para5}</p>` : ''}
          </div>
        </div>

        <div class="results-grid-compact">
          <div class="result-card-compact">
            <div class="result-label-compact">Success Rate</div>
            <div class="result-value-primary ${successClass}">${successRate}%</div>
          </div>
          <div class="result-card-compact">
            <div class="result-label-compact">Median Final Balance</div>
            <div class="result-value-primary">${formatCurrency(data.medianBalance)}</div>
          </div>
          <div class="result-card-compact">
            <div class="result-label-compact">20th Percentile</div>
            <div class="result-value-primary">${formatCurrency(data.percentile20)}</div>
          </div>
          <div class="result-card-compact">
            <div class="result-label-compact">80th Percentile</div>
            <div class="result-value-primary">${formatCurrency(data.percentile80)}</div>
          </div>
        </div>

        <div class="metrics-secondary">
          <div class="metrics-secondary-row">
            <span class="metric-item"><span class="metric-label">IRR (Net):</span> <span class="metric-value">${medianIRR}</span></span>
            <span class="metric-separator">•</span>
            <span class="metric-item"><span class="metric-label">Volatility:</span> <span class="metric-value">${medianVol}</span></span>
            <span class="metric-separator">•</span>
            <span class="metric-item"><span class="metric-label">Stock Returns:</span> <span class="metric-value">${stockMedian}</span> <span class="metric-label">(${stockRange})</span></span>
            <span class="metric-separator">•</span>
            <span class="metric-item"><span class="metric-label">Bond Returns:</span> <span class="metric-value">${bondMedian}</span> <span class="metric-label">(${bondRange})</span></span>
          </div>
        </div>

        <div class="chart-container">
          <h3>Portfolio Balance Over Time</h3>
          <canvas id="portfolioChart"></canvas>
        </div>

        <div class="chart-container">
          <h3>Distribution of Final Balances</h3>
          <canvas id="distributionChart"></canvas>
        </div>
      `;

      lastSimulationResults = data;

      // Draw charts after HTML is ready
      drawPortfolioChart(data);
      drawDistributionChart(data);
      setupEmailPdfTrigger();
      captureChartImagesDelayed();

      // Populate Detailed Outcome tab
      populateDetailedOutcome(data);

      // Populate Detailed Failure tab (if there are failures)
      populateDetailedFailure(data);
      notifyParentHeight();
    }

    // Toggle explanation section collapse
    function toggleExplanation() {
      const content = document.getElementById('explanationContent');
      const toggle = document.getElementById('explanationToggle');
      if (content && toggle) {
        content.classList.toggle('collapsed');
        toggle.classList.toggle('collapsed');
        toggle.setAttribute('aria-expanded', !content.classList.contains('collapsed'));
        setTimeout(notifyParentHeight, 350);
      }
    }

    function setupEmailPdfTrigger() {
      const trigger = document.getElementById('emailPdfTrigger');
      if (!trigger) return;
      if (trigger.dataset.bound === 'true') return;
      trigger.dataset.bound = 'true';
      trigger.addEventListener('click', (event) => {
        event.preventDefault();
        openEmailPdfModal();
      });
      notifyParentHeight();
    }

    function captureChartImagesDelayed() {
      setTimeout(() => {
        captureChartImages();
      }, 400);
    }

    function captureChartImages() {
      try {
        if (portfolioChartStatic) {
          lastPortfolioChartImage = portfolioChartStatic.toBase64Image('image/png', 1);
        }
      } catch (error) {
        console.warn('Unable to capture portfolio chart image', error);
      }

      try {
        if (distributionChartStatic) {
          lastDistributionChartImage = distributionChartStatic.toBase64Image('image/png', 1);
        }
      } catch (error) {
        console.warn('Unable to capture distribution chart image', error);
      }
    }

    const emailPdfModal = document.getElementById('emailPdfModal');
    const emailPdfForm = document.getElementById('emailPdfForm');
    const emailPdfClose = document.getElementById('emailPdfClose');
    const emailPdfFeedback = document.getElementById('emailPdfFeedback');
    const sendPdfButton = document.getElementById('sendPdfButton');
    const emailPdfEmailInput = document.getElementById('emailPdfEmail');
    let isSendingPdf = false;

    function openEmailPdfModal() {
      if (!lastSimulationResults || !lastSimulationParams) {
        alert('Please run a simulation before requesting a PDF.');
        return;
      }

      if (!emailPdfModal) return;

      captureChartImages();
      emailPdfModal.classList.add('visible');
      emailPdfModal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      setPdfFeedback('');
      setPdfSendingState(false);
      emailPdfEmailInput?.focus();
      notifyParentHeight();
    }

    function closeEmailPdfModal() {
      if (!emailPdfModal) return;
      emailPdfModal.classList.remove('visible');
      emailPdfModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      setPdfSendingState(false);
      notifyParentHeight();
    }

    function setPdfFeedback(message, isError = false) {
      if (!emailPdfFeedback) return;
      emailPdfFeedback.textContent = message;
      emailPdfFeedback.classList.remove('success', 'error');
      if (message) {
        emailPdfFeedback.classList.add(isError ? 'error' : 'success');
      }
      notifyParentHeight();
    }

    function setPdfSendingState(isSending) {
      isSendingPdf = isSending;
      if (!sendPdfButton) return;
      sendPdfButton.disabled = isSending;
      sendPdfButton.textContent = isSending ? 'Sending…' : 'Email PDF';
    }

    emailPdfClose?.addEventListener('click', () => closeEmailPdfModal());
    emailPdfModal?.addEventListener('click', (event) => {
      if (event.target === emailPdfModal) {
        closeEmailPdfModal();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && emailPdfModal.classList.contains('visible')) {
        closeEmailPdfModal();
      }
    });

    emailPdfForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (isSendingPdf) return;

      if (!lastSimulationResults || !lastSimulationParams) {
        setPdfFeedback('Please run the simulation before requesting a PDF.', true);
        return;
      }

      const formData = new FormData(emailPdfForm);
      const contact = {
        email: (formData.get('email') ?? '').toString().trim(),
        name: (formData.get('name') ?? '').toString().trim(),
        lastName: (formData.get('last_name') ?? '').toString().trim(),
        phone: (formData.get('phone') ?? '').toString().trim(),
      };

      if (!contact.email) {
        setPdfFeedback('Email is required.', true);
        emailPdfEmailInput?.focus();
        return;
      }

      setPdfFeedback('Sending your PDF…');
      setPdfSendingState(true);

      let emailSuccess = false;
      let emailErrorMessage = '';

      try {
        const emailResponse = await fetch('/api/retirement/email-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contact,
            simulation: lastSimulationResults,
            assumptions: lastSimulationParams,
            mode: 'email',
            charts: {
              portfolio: lastPortfolioChartImage,
              distribution: lastDistributionChartImage,
            },
          }),
        });

        if (!emailResponse.ok) {
          let errorMessage = 'Failed to send PDF email.';
          try {
            const errorResult = await emailResponse.json();
            if (errorResult?.error) {
              errorMessage = errorResult.error;
            }
          } catch (_) {
            // Ignore JSON parse errors
          }
          throw new Error(errorMessage);
        }

        const emailResult = await emailResponse.json().catch(() => null);
        if (emailResult?.ok === false && emailResult?.error) {
          throw new Error(emailResult.error);
        }
        emailSuccess = true;
      } catch (error) {
        console.error('PDF email error:', error);
        emailErrorMessage =
          error instanceof Error ? error.message : 'Unable to send the PDF right now.';
      }

      setPdfSendingState(false);

      if (emailSuccess) {
        setPdfFeedback('PDF emailed successfully.');
        emailPdfForm.reset();
        setTimeout(() => {
          closeEmailPdfModal();
          setPdfFeedback('');
        }, 2000);
      } else {
        setPdfFeedback(emailErrorMessage || 'Unable to send the PDF right now.', true);
      }
      notifyParentHeight();
    });

    function populateDetailedOutcome(data) {
      const detailedDiv = document.getElementById('detailedOutcome');
      
      try {
        if (!data.medianSimulationDetails || data.medianSimulationDetails.length === 0) {
          detailedDiv.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 40px;">No detailed data available</p>';
          notifyParentHeight();
          return;
        }

        const yearData = data.medianSimulationDetails;
        const finalBalance = yearData[yearData.length - 1].endBalance || 0;
        const totalContributions = yearData.reduce((sum, y) => sum + (y.contributions || 0), 0);
        const totalWithdrawals = yearData.reduce((sum, y) => sum + (y.withdrawalGross || 0), 0);
        const totalReturns = yearData.reduce((sum, y) => sum + (y.returns || 0), 0);
        const medianIRR = (data.medianIRR !== undefined && !isNaN(data.medianIRR)) ? data.medianIRR.toFixed(2) + '%' : 'N/A';
        const medianVolatility = (data.medianVolatility !== undefined && !isNaN(data.medianVolatility)) ? data.medianVolatility.toFixed(2) + '%' : 'N/A';

      let html = `
        <div class="detailed-summary">
          <h4>Median Scenario Details (Simulation #${data.medianSimulationIndex})</h4>
          <p>This shows the year-by-year progression of the simulation that had the median final balance (ranked 500th out of 1,000 scenarios).</p>
          <div class="summary-stats">
            <div class="summary-stat">
              <div class="summary-stat-label">Final Balance</div>
              <div class="summary-stat-value">${formatCurrency(finalBalance)}</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-label">Total Contributions</div>
              <div class="summary-stat-value positive">${formatCurrency(totalContributions)}</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-label">Total Withdrawals</div>
              <div class="summary-stat-value negative">${formatCurrency(totalWithdrawals)}</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-label">Total Investment Returns</div>
              <div class="summary-stat-value">${formatCurrency(totalReturns)}</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-label">Net Gain</div>
              <div class="summary-stat-value">${formatCurrency(finalBalance - yearData[0].startBalance)}</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-label">Median IRR</div>
              <div class="summary-stat-value">${medianIRR}</div>
              <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">Internal Rate of Return (Net of Fees)</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-label">Median Volatility</div>
              <div class="summary-stat-value">${medianVolatility}</div>
              <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">Annualized Standard Deviation</div>
            </div>
          </div>
        </div>

        <table class="detailed-table">
          <thead>
            <tr>
              <th>Year</th>
              <th>Age</th>
              <th>Start Balance</th>
              <th>Stock Return</th>
              <th>Bond Return</th>
              <th>Total Returns</th>
              <th>Contributions</th>
              <th>Withdrawal (Gross)</th>
              <th>Tax</th>
              <th>Withdrawal (Net)</th>
              <th>End Balance</th>
              <th>Net Change</th>
            </tr>
          </thead>
          <tbody>
      `;

      yearData.forEach((row, index) => {
        const phaseClass = row.phase === 'Accumulation' ? 'phase-accumulation' : 'phase-retirement';
        const netChange = row.netChange || 0;
        const netClass = netChange >= 0 ? 'positive' : 'negative';

        html += `
          <tr class="${phaseClass} year-row" data-year="${row.year}" onclick="toggleMonthly(${row.year})">
            <td><span class="expand-icon" id="expand-${row.year}">▶</span> ${row.year || 0}</td>
            <td>${row.age || 0}</td>
            <td>${formatCurrency(row.startBalance || 0)}</td>
            <td>${row.stockReturn || '0.0%'}</td>
            <td>${row.bondReturn || '0.0%'}</td>
            <td class="${(row.returns || 0) >= 0 ? 'positive' : 'negative'}">${formatCurrency(row.returns || 0, true)}</td>
            <td class="positive">${(row.contributions || 0) > 0 ? '+' + formatCurrency(row.contributions) : '—'}</td>
            <td class="negative">${(row.withdrawalGross || 0) > 0 ? '-' + formatCurrency(row.withdrawalGross) : '—'}</td>
            <td class="negative">${(row.tax || 0) > 0 ? '-' + formatCurrency(row.tax) : '—'}</td>
            <td style="color: var(--text-dark);">${(row.withdrawalNet || 0) > 0 ? formatCurrency(row.withdrawalNet) : '—'}</td>
            <td><strong>${formatCurrency(row.endBalance || 0)}</strong></td>
            <td class="${netClass}">${formatCurrency(netChange, true)}</td>
          </tr>
        `;

        // Add monthly detail rows (hidden by default)
        if (row.monthlyDetails && row.monthlyDetails.length > 0) {
          row.monthlyDetails.forEach(monthData => {
            const monthNetClass = (monthData.netChange || 0) >= 0 ? 'positive' : 'negative';
            const monthReturnClass = (monthData.returns || 0) >= 0 ? 'positive' : 'negative';
            
            // Safely get values with defaults
            const startStockBal = monthData.startStockBalance ?? 0;
            const startBondBal = monthData.startBondBalance ?? 0;
            const startBal = monthData.startBalance ?? 0;
            
            // Calculate allocation percentage at START of month (for verification)
            let startStockPct = '0.0';
            let startBondPct = '0.0';
            
            if (startBal > 0 && !isNaN(startBal)) {
              const stockPctVal = (startStockBal / startBal) * 100;
              const bondPctVal = (startBondBal / startBal) * 100;
              startStockPct = !isNaN(stockPctVal) ? stockPctVal.toFixed(1) : '0.0';
              startBondPct = !isNaN(bondPctVal) ? bondPctVal.toFixed(1) : '0.0';
            }
            
            // Verify the calculation: startStock × stockReturn + startBond × bondReturn = returns
            const stockReturnNum = parseFloat(monthData.stockReturn || '0') / 100;
            const bondReturnNum = parseFloat(monthData.bondReturn || '0') / 100;
            const calculatedReturns = (startStockBal * stockReturnNum) + (startBondBal * bondReturnNum);
            const safeCalculatedReturns = !isNaN(calculatedReturns) ? calculatedReturns : 0;
            
            html += `
              <tr class="monthly-row monthly-year-${row.year}">
                <td class="monthly-label" colspan="2">
                  ${monthData.monthName || 'N/A'} (Month ${monthData.month || 0})
                  <span style="color: var(--muted); font-size: 10px; margin-left: 8px;">
                    START: Stocks ${formatCurrency(startStockBal, true)} (${startStockPct}%) | 
                    Bonds ${formatCurrency(startBondBal, true)} (${startBondPct}%)
                  </span>
                </td>
                <td>${formatCurrency(monthData.startBalance || 0)}</td>
                <td>${monthData.stockReturn || '0.0%'}</td>
                <td>${monthData.bondReturn || '0.0%'}</td>
                <td class="${monthReturnClass}" title="Calculated: ${formatCurrency(safeCalculatedReturns)}">${formatCurrency(monthData.returns || 0, true)}</td>
                <td class="positive">${(monthData.contribution || 0) > 0 ? '+' + formatCurrency(monthData.contribution || 0) : '—'}</td>
                <td class="negative">${(monthData.withdrawalGross || 0) > 0 ? '-' + formatCurrency(monthData.withdrawalGross || 0) : '—'}</td>
                <td class="negative">${(monthData.tax || 0) > 0 ? '-' + formatCurrency(monthData.tax || 0) : '—'}</td>
                <td style="color: var(--text-dark);">${(monthData.withdrawalNet || 0) > 0 ? formatCurrency(monthData.withdrawalNet || 0) : '—'}</td>
                <td><strong>${formatCurrency(monthData.balance || 0)}</strong></td>
                <td class="${monthNetClass}">${formatCurrency(monthData.netChange || 0, true)}</td>
              </tr>
            `;
          });
        }
      });

      html += `
          </tbody>
        </table>
      `;

      detailedDiv.innerHTML = html;
      notifyParentHeight();
      // Extra delayed notification to ensure large tables are fully rendered
      setTimeout(notifyParentHeight, 100);
      setTimeout(notifyParentHeight, 300);
      } catch (error) {
        console.error('Error populating detailed outcome:', error);
        detailedDiv.innerHTML = `<div class="alert alert-error">Error displaying detailed results: ${error.message}</div>`;
        notifyParentHeight();
      }
    }

    function populateDetailedFailure(data) {
      const detailedDiv = document.getElementById('detailedFailure');
      const failureTabBtn = document.getElementById('failureTab');

      try {
        // Hide tab if no failures
        if (!data.medianFailureDetails || data.failureCount === 0) {
          if (failureTabBtn) failureTabBtn.style.display = 'none';
          detailedDiv.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 40px;">No failure scenarios to display</p>';
          notifyParentHeight();
          return;
        }

        // Show the failure tab button
        if (failureTabBtn) failureTabBtn.style.display = 'block';

        const yearData = data.medianFailureDetails;
        const failureAge = data.medianFailureAge || 0;
        const totalContributions = yearData.reduce((sum, y) => sum + (y.contributions || 0), 0);
        const totalWithdrawals = yearData.reduce((sum, y) => sum + (y.withdrawalGross || 0), 0);
        const totalReturns = yearData.reduce((sum, y) => sum + (y.returns || 0), 0);

      let html = `
        <div class="detailed-summary">
          <h4 style="color: #c0392b;">Median Failure Scenario (Simulation #${data.medianFailureIndex})</h4>
          <p>This shows the year-by-year progression of the median failure scenario. Out of ${data.failureCount} scenarios where money ran out, this is the median (ranked by when money ran out).</p>
          <div class="summary-stats">
            <div class="summary-stat">
              <div class="summary-stat-label">Money Ran Out At Age</div>
              <div class="summary-stat-value" style="color: #c0392b;">${failureAge}</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-label">Failed Scenarios</div>
              <div class="summary-stat-value" style="color: #c0392b;">${data.failureCount} of 1,000</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-label">Total Contributions</div>
              <div class="summary-stat-value positive">${formatCurrency(totalContributions)}</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-label">Total Withdrawals</div>
              <div class="summary-stat-value negative">${formatCurrency(totalWithdrawals)}</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-label">Total Investment Returns</div>
              <div class="summary-stat-value">${formatCurrency(totalReturns)}</div>
            </div>
          </div>
        </div>

        <table class="detailed-table">
          <thead>
            <tr>
              <th>Year</th>
              <th>Age</th>
              <th>Start Balance</th>
              <th>Stock Return</th>
              <th>Bond Return</th>
              <th>Total Returns</th>
              <th>Contributions</th>
              <th>Withdrawal (Gross)</th>
              <th>Tax</th>
              <th>Withdrawal (Net)</th>
              <th>End Balance</th>
              <th>Net Change</th>
            </tr>
          </thead>
          <tbody>
      `;

      yearData.forEach((row, index) => {
        const phaseClass = row.phase === 'Accumulation' ? 'phase-accumulation' : 'phase-retirement';
        const netChange = row.netChange || 0;
        const netClass = netChange >= 0 ? 'positive' : 'negative';
        const isFailed = row.endBalance === 0;

        html += `
          <tr class="${phaseClass} year-row ${isFailed ? 'failure-row' : ''}" data-year="${row.year}" onclick="toggleFailureMonthly(${row.year})" style="${isFailed ? 'background-color: #fff5f5;' : ''}">
            <td><span class="expand-icon" id="failure-expand-${row.year}">▶</span> ${row.year || 0}</td>
            <td>${row.age || 0}</td>
            <td>${formatCurrency(row.startBalance || 0)}</td>
            <td>${row.stockReturn || '0.0%'}</td>
            <td>${row.bondReturn || '0.0%'}</td>
            <td class="${(row.returns || 0) >= 0 ? 'positive' : 'negative'}">${formatCurrency(row.returns || 0, true)}</td>
            <td class="positive">${(row.contributions || 0) > 0 ? '+' + formatCurrency(row.contributions) : '—'}</td>
            <td class="negative">${(row.withdrawalGross || 0) > 0 ? '-' + formatCurrency(row.withdrawalGross) : '—'}</td>
            <td class="negative">${(row.tax || 0) > 0 ? '-' + formatCurrency(row.tax) : '—'}</td>
            <td style="color: var(--text-dark);">${(row.withdrawalNet || 0) > 0 ? formatCurrency(row.withdrawalNet) : '—'}</td>
            <td><strong style="${isFailed ? 'color: #c0392b;' : ''}">${formatCurrency(row.endBalance || 0)}</strong></td>
            <td class="${netClass}">${formatCurrency(netChange, true)}</td>
          </tr>
        `;

        // Add monthly detail rows (hidden by default)
        if (row.monthlyDetails && row.monthlyDetails.length > 0) {
          row.monthlyDetails.forEach(monthData => {
            const monthNetClass = (monthData.netChange || 0) >= 0 ? 'positive' : 'negative';
            const monthReturnClass = (monthData.returns || 0) >= 0 ? 'positive' : 'negative';
            const monthFailed = monthData.balance === 0;

            // Safely get values with defaults
            const startStockBal = monthData.startStockBalance ?? 0;
            const startBondBal = monthData.startBondBalance ?? 0;
            const startBal = monthData.startBalance ?? 0;

            // Calculate allocation percentage at START of month
            let startStockPct = '0.0';
            let startBondPct = '0.0';

            if (startBal > 0 && !isNaN(startBal)) {
              const stockPctVal = (startStockBal / startBal) * 100;
              const bondPctVal = (startBondBal / startBal) * 100;
              startStockPct = !isNaN(stockPctVal) ? stockPctVal.toFixed(1) : '0.0';
              startBondPct = !isNaN(bondPctVal) ? bondPctVal.toFixed(1) : '0.0';
            }

            html += `
              <tr class="monthly-row failure-monthly-year-${row.year}" style="${monthFailed ? 'background-color: #fff5f5;' : ''}">
                <td class="monthly-label" colspan="2">
                  ${monthData.monthName || 'N/A'} (Month ${monthData.month || 0})
                  <span style="color: var(--muted); font-size: 10px; margin-left: 8px;">
                    START: Stocks ${formatCurrency(startStockBal, true)} (${startStockPct}%) |
                    Bonds ${formatCurrency(startBondBal, true)} (${startBondPct}%)
                  </span>
                </td>
                <td>${formatCurrency(monthData.startBalance || 0)}</td>
                <td>${monthData.stockReturn || '0.0%'}</td>
                <td>${monthData.bondReturn || '0.0%'}</td>
                <td class="${monthReturnClass}">${formatCurrency(monthData.returns || 0, true)}</td>
                <td class="positive">${(monthData.contribution || 0) > 0 ? '+' + formatCurrency(monthData.contribution || 0) : '—'}</td>
                <td class="negative">${(monthData.withdrawalGross || 0) > 0 ? '-' + formatCurrency(monthData.withdrawalGross || 0) : '—'}</td>
                <td class="negative">${(monthData.tax || 0) > 0 ? '-' + formatCurrency(monthData.tax || 0) : '—'}</td>
                <td style="color: var(--text-dark);">${(monthData.withdrawalNet || 0) > 0 ? formatCurrency(monthData.withdrawalNet || 0) : '—'}</td>
                <td><strong style="${monthFailed ? 'color: #c0392b;' : ''}">${formatCurrency(monthData.balance || 0)}</strong></td>
                <td class="${monthNetClass}">${formatCurrency(monthData.netChange || 0, true)}</td>
              </tr>
            `;
          });
        }
      });

      html += `
          </tbody>
        </table>
      `;

      detailedDiv.innerHTML = html;
      notifyParentHeight();
      // Extra delayed notification to ensure large tables are fully rendered
      setTimeout(notifyParentHeight, 100);
      setTimeout(notifyParentHeight, 300);
      } catch (error) {
        console.error('Error populating detailed failure:', error);
        detailedDiv.innerHTML = `<div class="alert alert-error">Error displaying failure details: ${error.message}</div>`;
        notifyParentHeight();
      }
    }

    // Toggle monthly details for a year (Detailed Outcome tab)
    window.toggleMonthly = function(year) {
      const monthlyRows = document.querySelectorAll(`.monthly-year-${year}`);
      const expandIcon = document.getElementById(`expand-${year}`);
      
      if (monthlyRows.length === 0) return;
      
      const isVisible = monthlyRows[0].classList.contains('visible');
      
      monthlyRows.forEach(row => {
        if (isVisible) {
          row.classList.remove('visible');
        } else {
          row.classList.add('visible');
        }
      });
      
      if (expandIcon) {
        if (isVisible) {
          expandIcon.classList.remove('expanded');
          expandIcon.textContent = '▶';
        } else {
          expandIcon.classList.add('expanded');
          expandIcon.textContent = '▼';
        }
      }

      // Notify parent of height change
      setTimeout(notifyParentHeight, 50);
    };

    // Toggle monthly details for a year (Detailed Failure tab)
    window.toggleFailureMonthly = function(year) {
      const monthlyRows = document.querySelectorAll(`.failure-monthly-year-${year}`);
      const expandIcon = document.getElementById(`failure-expand-${year}`);

      if (monthlyRows.length === 0) return;

      const isVisible = monthlyRows[0].classList.contains('visible');

      monthlyRows.forEach(row => {
        if (isVisible) {
          row.classList.remove('visible');
        } else {
          row.classList.add('visible');
        }
      });

      if (expandIcon) {
        if (isVisible) {
          expandIcon.classList.remove('expanded');
          expandIcon.textContent = '▶';
        } else {
          expandIcon.classList.add('expanded');
          expandIcon.textContent = '▼';
        }
      }

      // Notify parent of height change
      setTimeout(notifyParentHeight, 50);
    };

    function createPortfolioChartConfig(data) {
      return {
        type: 'line',
        data: {
          labels: data.years,
          datasets: [
            {
              label: '80th Percentile',
              data: data.percentile80Path,
              borderColor: 'rgba(27, 156, 133, 0.6)',
              backgroundColor: 'rgba(27, 156, 133, 0.25)',
              fill: '+1',
              borderWidth: 2,
              pointRadius: 0
            },
            {
              label: 'Median (50th)',
              data: data.medianPath,
              borderColor: '#1B9C85',
              backgroundColor: 'rgba(27, 156, 133, 0.25)',
              fill: '+1',
              borderWidth: 3,
              pointRadius: 0
            },
            {
              label: '20th Percentile',
              data: data.percentile20Path,
              borderColor: 'rgba(27, 156, 133, 0.6)',
              backgroundColor: 'transparent',
              borderWidth: 2,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2,
          devicePixelRatio: 2,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Age'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Portfolio Balance'
              },
              ticks: {
                callback: (value) => formatCurrency(value, true)
              }
            }
          }
        }
      };
    }

    function createDistributionChartConfig(data) {
      return {
        type: 'bar',
        data: {
          labels: data.distributionLabels || [],
          datasets: [{
            label: 'Percentage of Simulations',
            data: data.distributionPercentages || [],
            backgroundColor: 'rgba(27, 156, 133, 0.6)',
            borderColor: '#1B9C85',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2,
          devicePixelRatio: 2,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: (context) => `${context.parsed.y.toFixed(1)}% of simulations`
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Final Balance Range'
              }
            },
            y: {
              title: {
                display: true,
                text: '% of Simulations'
              },
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value.toFixed(0) + '%';
                }
              }
            }
          }
        }
      };
    }

    function drawPortfolioChart(data) {
      const ctx = document.getElementById('portfolioChart');
      const staticCanvas = document.getElementById('portfolioChartStatic');
      
      if (portfolioChart) {
        portfolioChart.destroy();
      }
      const config = createPortfolioChartConfig(data);
      portfolioChart = new Chart(ctx, config);

      if (portfolioChartStatic) {
        portfolioChartStatic.destroy();
      }
      if (staticCanvas) {
        const staticConfig = createPortfolioChartConfig(data);
        staticConfig.options.responsive = false;
        staticConfig.options.maintainAspectRatio = false;
        staticConfig.options.animation = false;
        staticConfig.options.aspectRatio = undefined;
        portfolioChartStatic = new Chart(staticCanvas.getContext('2d'), staticConfig);
      }
    }

    function drawDistributionChart(data) {
      const ctx = document.getElementById('distributionChart');
      const staticCanvas = document.getElementById('distributionChartStatic');
      
      if (distributionChart) {
        distributionChart.destroy();
      }

      // Debug: Log the data
      console.log('Distribution labels:', data.distributionLabels);
      console.log('Distribution percentages:', data.distributionPercentages);

      const config = createDistributionChartConfig(data);
      distributionChart = new Chart(ctx, config);

      if (distributionChartStatic) {
        distributionChartStatic.destroy();
      }
      if (staticCanvas) {
        const staticConfig = createDistributionChartConfig(data);
        staticConfig.options.responsive = false;
        staticConfig.options.maintainAspectRatio = false;
        staticConfig.options.animation = false;
        staticConfig.options.aspectRatio = undefined;
        distributionChartStatic = new Chart(staticCanvas.getContext('2d'), staticConfig);
      }
    }

    function formatCurrency(value, short = false) {
      // Handle null, undefined, NaN
      if (value === null || value === undefined || isNaN(value)) {
        return '$0';
      }
      
      if (value < 0) {
        return '-$' + Math.abs(value).toLocaleString('en-US', { maximumFractionDigits: 0 });
      }
      
      if (short && value >= 1000000) {
        return '$' + (value / 1000000).toFixed(1) + 'M';
      } else if (short && value >= 1000) {
        return '$' + (value / 1000).toFixed(0) + 'K';
      }
      
      return '$' + value.toLocaleString('en-US', { maximumFractionDigits: 0 });
    }

    // Helper functions for return distribution statistics
    function calculateMedian(arr) {
      if (!arr || arr.length === 0) return 0;
      const sorted = [...arr].sort((a, b) => a - b);
      return sorted[Math.floor(sorted.length / 2)];
    }

    function calculatePercentile(arr, percentile) {
      if (!arr || arr.length === 0) return 0;
      const sorted = [...arr].sort((a, b) => a - b);
      return sorted[Math.floor(sorted.length * percentile)];
    }

    // Initialize
    updateAllocationTotal();
    updateExpectedCAGR();
    notifyParentHeight();
  </script>
</body>
</html>

